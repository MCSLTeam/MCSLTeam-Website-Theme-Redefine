"use strict";const crypto=require("crypto"),fs=require("fs"),path=require("path"),log=hexo.log,{hbeTheme:hbeTheme}=require("./lib/hbe.default.js"),defaultConfig={abstract:"Here's something encrypted, password is required to continue reading.",message:"Hey, password is required here.",theme:"default",wrong_pass_message:"Oh, this is an invalid password. Check and try again, please.",wrong_hash_message:"OOPS, these decrypted content may changed, but you can still have a look.",silent:!1},keySalt=textToArray("hexo-blog-encrypt的作者们都是大帅比!"),ivSalt=textToArray("hexo-blog-encrypt是地表最强Hexo加密插件!"),knownPrefix="<hbe-prefix></hbe-prefix>";var silent=!1,theme="default";function dlog(e,t){switch(e){case"warn":log.warn(t);break;case"info":default:if(silent)return;log.info(t)}}function textToArray(e){for(var t=e.length,r=0,s=new Array,n=0;n<t;){var a=e.codePointAt(n);a<128?(s[r++]=a,n++):a>127&&a<2048?(s[r++]=a>>6|192,s[r++]=63&a|128,n++):a>2047&&a<65536?(s[r++]=a>>12|224,s[r++]=a>>6&63|128,s[r++]=63&a|128,n++):(s[r++]=a>>18|240,s[r++]=a>>12&63|128,s[r++]=a>>6&63|128,s[r++]=63&a|128,n+=2)}return new Uint8Array(s)}hexo.extend.filter.register("after_post_render",e=>{const t=[];let r=e.password,s=!1;if(""===r)return e;if(void 0===hexo.config.encrypt&&(hexo.config.encrypt=[]),"encrypt"in hexo.config&&"tags"in hexo.config.encrypt&&hexo.config.encrypt.tags.forEach(e=>{t[e.name]=e.password}),e.tags&&e.tags.forEach(e=>{t.hasOwnProperty(e.name)&&(s=r?s:e.name,r=r||t[e.name])}),null==r)return e;r=r.toString(),e.origin=e.content;const n=Object.assign(defaultConfig,hexo.config.encrypt,e);silent=n.silent,theme=n.theme.trim().toLowerCase(),n.template&&dlog("warn",'Looks like you use a deprecated property "template" to set up template, consider to use "theme"? See https://github.com/D0n9X1n/hexo-blog-encrypt#encrypt-theme');let a=hbeTheme;dlog("info",!1===s?`hexo-blog-encrypt: encrypting "${e.title.trim()}" based on the password configured in Front-matter with theme: ${theme}.`:`hexo-blog-encrypt: encrypting "${e.title.trim()}" based on Tag: "${s}" with theme ${theme}.`),e.content=knownPrefix+e.content.trim(),e.encrypt=!0;const o=crypto.pbkdf2Sync(r,keySalt,1024,32,"sha256"),c=crypto.pbkdf2Sync(r,ivSalt,512,16,"sha256"),i=crypto.createCipheriv("aes-256-cbc",o,c),h=crypto.createHmac("sha256",o);let p=i.update(e.content,"utf8","hex");h.update(e.content,"utf8"),p+=i.final("hex");const g=h.digest("hex");return e.content=a.replace(/{{hbeEncryptedData}}/g,p).replace(/{{hbeHmacDigest}}/g,g).replace(/{{hbeWrongPassMessage}}/g,n.wrong_pass_message).replace(/{{hbeWrongHashMessage}}/g,n.wrong_hash_message).replace(/{{hbeMessage}}/g,n.message),e.content+=`<script data-swup-reload-script src="${hexo.config.root}lib/hbe.js"><\/script><link href="${hexo.config.root}css/hbe.style.css" rel="stylesheet" type="text/css">`,e.excerpt=e.more=n.abstract,e},1e3),hexo.extend.generator.register("hexo-blog-encrypt",()=>[{data:()=>fs.createReadStream(path.resolve(__dirname,"../../source/assets/hbe.style.css")),path:"css/hbe.style.css"},{data:()=>fs.createReadStream(path.resolve(__dirname,"../../source/js/plugins/hbe.js")),path:"lib/hbe.js"}]);